"use strict";angular.module("app",["ui.router","ngAnimate","ngTouch","ui.bootstrap","app.components.navbar","app.components.books.grid","app.components.fallbackimage","app.components.alerts","app.services.BookService","app.services.CategoryService","app.services.ConfigurationService","app.services.UtilService","app.services.SpinnerService","app.filters.html","app.router"]).constant("_",window._).constant("he",window.he).constant("moment",window.moment).config(["$locationProvider","$qProvider","$httpProvider",function(e,t,o){e.html5Mode(!0),o.interceptors.push("myHttpInterceptor")}]).run(["$rootScope","$http","$httpParamSerializerJQLike","AppConfig","ConfigurationService","$log",function(e,t,o,r,a,n){t.defaults.headers.common["app-key"]=r.api_key,t.defaults.transformRequest.unshift(o),t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8",t.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8",a.getConfig().then(function(e){angular.extend(r,e),n.info("[app.js] Configuration fetched.")}).catch(function(e){n.error("[app.js] error",e)}),e.$on("$stateChangeStart",function(e,t,o,r,a){n.info("[app.js] $stateChangeStart")}),e.$on("$stateChangeSuccess",function(e,t,o,r){n.info("[app.js] $stateChangeSuccess")})}]).factory("myHttpInterceptor",["$q",function(e){return{request:function(e){return e},requestError:function(t){return canRecover(t)?responseOrNewPromise:e.reject(t)},response:function(e){return e},responseError:function(t){return canRecover(t)?responseOrNewPromise:e.reject(t)}}}]);var _alertsDirective=function(e,t){function o(o,r,a){return o.alerts=[],o.closeAlert=function(e){o.alerts.splice(e,1)},o.collection&&o.collection.length?o.collection[0].type&&o.collection[0].message?void(o.alerts=t.concat(o.alerts,o.collection)):void e.error("Alerts shoud have objects with 'type' and 'message' properties"):void o.alerts.push({type:o.type,message:o.message})}return{restrict:"E",scope:{type:"=",message:"=",collection:"="},templateUrl:"partials/directives/alerts",replace:!0,link:o}};angular.module("app.components.alerts",[]).directive("alertContainer",["$log","_",_alertsDirective]);var _gridBook=function(e,t,o){function r(e,r,a){e.rows=t.createRows(e.items),o.mode=a.mode||"complete"}return{restrict:"E",scope:{items:"=",search:"="},templateUrl:function(){return"app-templates/gridbook"},replace:!0,link:r}},_gridBookItem=function(){return{restrict:"E",replace:!0,transclude:!0,scope:{bookid:"@"},templateUrl:function(){return"app-templates/gridbookItem"}}},_gridBookData=function(e,t,o){function r(t,r,a){t.data.published_date=e(t.data.published_date).format("LL"),t.data.available=!t.data.user,t.data.name=o.decode(t.data.name),t.data.author=o.decode(t.data.author),t.data.user=o.decode(t.data.user)}return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:function(e,o){var r=t.mode||"complete";switch(r){case"title":case"poster":return"app-templates/gridbookPoster";case"complete":return"app-templates/gridbookData";default:return"app-templates/gridbookData"}},link:r}};angular.module("app.components.books.grid",[]).run(["$templateCache",function(e){var t='                <div class="row" ng-repeat="row in rows">                     <div ng-repeat="item in row.items | filter:search as results">                        <grid-book-item bookid="{{ item._id }}">                            <grid-book-data                                data="item"                        </grid-book-item>                    </div>                </div>',o='                <div class="col-md-2 fadeIn animated">                    <div class="thumbnail card-link">                        <a ui-sref="books.detail({ book_id: bookid })">                            <ng-transclude></ng-transclude>                        </a>                    </div>                </div>',r='                <div>                    <img ng-src="{{ data.poster }}" alt="{{ data.name }}" style="width:100%">                    <div class="caption">                        <h5>{{ data.name }}<br><small>{{ data.author }}</small></h5>                        <p>                            <strong>Category:</strong><br /><span class="label label-primary">{{ data.category }}</span><br />                            <strong>Date Published:</strong><br />{{ data.published_date }}<br />                            <span ng-if="data.available"><strong>Status:</strong><br /><span class="label label-success">Available</span></span>                            <span ng-if="!data.available">                                <strong>Status:</strong><br /><span class="label label-default">No available</span><br>                                <strong>User:</strong><br />{{ data.user }}                            </span>                        </p>                    </div>                </div>',a='                <div>                    <img ng-src="{{ data.poster }}" alt="{{ data.name }}" style="width:100%">                    <div class="caption">                        <h5>{{ data.name }}</h5>                    </div>                </div>';e.put("app-templates/gridbook",t),e.put("app-templates/gridbookItem",o),e.put("app-templates/gridbookData",r),e.put("app-templates/gridbookPoster",a)}]).directive("gridBook",["_","UtilService","$rootScope",_gridBook]).directive("gridBookItem",[_gridBookItem]).directive("gridBookData",["moment","$rootScope","he",_gridBookData]);var _fallBackImage=function(e){function t(e,t,o){var r=o.fallbackSrc||"https://unsplash.it/g/333/500/?random";t.attr("src",r),t.bind("error",function(){angular.element(this).attr("src",r)})}return{link:t}};angular.module("app.components.fallbackimage",[]).directive("fallbackSrc",["$rootScope",_fallBackImage]);var _navbarDirective=function(e){return{restrict:"E",templateUrl:"partials/directives/navbar",replace:!0}};angular.module("app.components.navbar",[]).directive("navBar",["$rootScope",_navbarDirective]);var _AppConfig=function(){var e={api_key:"48rXl9ZG7dm0EAWez4Ls3LyFYVA0g8a4",api_url:"http://api.demo.aguilarcarlos.com/content",base_url:"http://api.demo.aguilarcarlos.com",paths:{book_and_category:"category/book",book:"books/{book_id}",books_category:"/books/category/{category_id}",books:"books",category:"categories/{category_id}",category_books:"categories/{category_id}/books",categories:"categories"}};return{set:function(t){angular.extend(e,t)},$get:function(){return e}}};angular.module("app").provider("AppConfig",[_AppConfig]);var BookController=function(e,t,o,r,a,n,i,s,c,l,u){function d(t){e.loaded=!t,n[t?"show":"hide"]()}function p(){d(!0),t.getBooks().then(function(t){return d(!1),t.length?void(e.books=t):void(e.empty=!0)}).catch(function(t){e.empty=!0})}function g(o){d(!0),t.deleteBook(o).then(function(e){t.flushAll(),d(!1),r.go("books.index",{},{reload:!0})}).catch(function(t){n.hide(),e.alerts.push({type:"danger",message:"Something went wrong deleting the user."})})}function m(a,i){d(!0),t.createBook(a).then(function(a){return d(!1),e.book={},t.flushAll(),i?(o.info("Saving and going to books..."),void r.go("books.index",{},{reload:!0})):void e.alerts.push({type:"success",message:a})}).catch(function(t){n.hide(),e.alerts.push({type:"danger",message:t})})}function f(o){d(!0),t.getBook(o).then(function(t){return d(!1),t?(t.name=u.decode(t.name),t.author=u.decode(t.author),t.user=u.decode(t.user),t.published_date=a(t.published_date).format("LL"),t.available=!t.user,void(e.bookDetails=t)):void(e.empty=!0)}).catch(function(t){n.hide(),e.empty=!0,e.alerts.push({type:"danger",message:t})})}function v(a,i,s){d(!0),t.updateBook(a,i).then(function(a){return d(!1),e.current={},e.book={},t.flushAll(),s?(o.info("Updating and going to books..."),void r.go("books.index",{},{reload:!0})):void r.go(r.current,{status:"updated"},{reload:!0})}).catch(function(t){n.hide(),e.alerts.push({type:"danger",message:"Something wrong has happened with the book: "+t})})}function h(){d(!0),i.getCategories().then(function(t){d(!1),e.categories=t}).catch(function(t){n.hide(),e.empty=!0,e.alerts.push({type:"danger",message:t})})}function b(o){d(!0),t.getBook(o).then(function(t){i.getCategories().then(function(o){d(!1),t.name=u.decode(t.name),t.author=u.decode(t.author),t.user=u.decode(t.user),e.current=t,e.current.published_date=new Date(e.current.published_date),e.categories=o,e.book.user=e.current.user,e.book._id=e.current._id}).catch(function(t){n.hide(),e.empty=!0,e.alerts.push({type:"danger",message:"Something went wrong"})})}).catch(function(t){n.hide(),e.empty=!0,e.alerts.push({type:"danger",message:"Something went wrong"})})}function k(){switch(o.debug("BookController loaded..."),r.current.name){case"books.index":p();break;case"books.detail":if(r.params.book_id)return void f(r.params.book_id);r.go("books.index");break;case"books.edit":if(r.params.book_id)return void b(r.params.book_id);break;case"books.create":e.picker={opened:!1},e.dateOptions={formatYear:"yy",maxDate:new Date(2020,5,22),minDate:new Date(820,5,22),startingDay:1},h();break;default:p()}}e.books=[],e.book={},e.categories=[],e.loaded=!1,e.empty=!1,e.alerts=[],e.editBook={},"updated"===l.status&&e.alerts.push({type:"success",message:"Book updated correctly"}),e.closeAlert=function(t){e.alerts.splice(t,1)},e.removeBook=function(e){e&&g(e)},e.editBook=function(e){r.go("books.edit",{book_id:e})},e.openDatePicker=function(){e.picker.opened=!0},e.createBook=function(e,t){t=!!t,m(e,t)},e.updateBook=function(e,t){t=!!t,v(e._id,e,t)},e.openModal=function(e,t){var a=c.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",controller:"ModalController",templateUrl:"/partials/directives/modalAvailability",size:e,resolve:{book:function(){return t}}});a.result.then(function(e){r.go(r.current,{status:"updated"},{reload:!0})},function(){o.debug("Dismiss modal")})},k()};angular.module("app").controller("BookController",["$scope","BookService","$log","$state","moment","SpinnerService","CategoryService","_","$uibModal","$stateParams","he",BookController]).controller("ModalController",["$scope","BookService","$log","book","he","$uibModalInstance",function(e,t,o,r,a,n){r.name=a.decode(r.name),r.author=a.decode(r.author),r.user=a.decode(r.user),e.book=r,e.alerts=[],e.update=function(){return 1===e.book.setAvailable&&(e.book.user=""),0!==e.book.setAvailable||e.book.user?void t.updateBook(e.book._id,e.book).then(function(o){t.flushAll(),n.close(e.book)}).catch(function(t){e.alerts.push({type:"danger",message:"Something wrong has happened with the book"})}):void e.alerts.push({type:"danger",message:"You MUST enter a name"})},e.closeAlert=function(t){e.alerts.splice(t,1)},e.cancel=function(){n.dismiss("cancel")}}]);var CategoryController=function(e,t,o,r,a,n){function i(){n.show(),t.getCategoriesWithBooks().then(function(t){n.hide(),t.length||(e.empty=!1),e.categories=t}).catch(function(e){console.log(e)})}function s(){o.debug("CategoryController loaded..."),i()}e.categories=[],e.empty=!1,e.loading=n.isVisible(),s()};angular.module("app").controller("CategoryController",["$scope","CategoryService","$log","$state","UtilService","SpinnerService",CategoryController]);var homeController=function(e){e.myInterval=5e3,e.noWrapSlides=!1,e.active=0;var t=e.slides=[],o=0;600+t.length+1;e.slides.push({image:"http://lorempixel.com/g/1200/400/city/1",text:"The book demo n1",id:o++},{image:"http://lorempixel.com/g/1200/400/city/2",text:"The book demo n2",id:o++},{image:"http://lorempixel.com/g/1200/400/city/3",text:"The book demo n3",id:o++})};angular.module("app").controller("HomeController",["$scope",homeController]),angular.module("app.filters.html",[]).filter("html",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),angular.module("app.router",["ui.router"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/",abstract:!0,template:"<div ui-view></div>"}),e.state("home.index",{url:"",templateUrl:"partials/home",controller:"HomeController"}),e.state("categories",{url:"/categories",abstract:!0,template:"<div ui-view></div>"}),e.state("categories.index",{url:"",templateUrl:"partials/categories",controller:"CategoryController"}),e.state("books",{url:"/books",abstract:!0,template:"<div ui-view></div>"}),e.state("books.index",{url:"",templateUrl:"partials/books",controller:"BookController"}),e.state("books.create",{url:"/create",templateUrl:"partials/booksCreate",controller:"BookController"}),e.state("books.detail",{url:"/:book_id?status",templateUrl:"partials/booksDetail",controller:"BookController"}),e.state("books.edit",{url:"/:book_id/edit?status",templateUrl:"partials/booksDetailEdit",controller:"BookController"}),t.when("/",["$state",function(e){e.go("home.index")}])}]);var _BookService=function(e,t,o,r,a,n){function i(o,r){var n=t.defer(),i=a.merge({cache:!0},a.isObject(r)?r:{});if(!o)return n.reject("Invalid Id"),n.promise;var s=p.book.replace("{book_id}",o);return i.refresh&&g.remove(s),e.get(s,i).then(function(e){return e=e.data||{},e.error||!e.data.length?(n.reject(e.message),n.promise):void n.resolve(e.data[0])},function(e){return e.data&&e.data.error?n.reject(error.message):void n.reject(e)}).catch(function(e){n.reject(e)}),n.promise}function s(o){var r=t.defer(),n=a.merge({cache:!0},a.isObject(o)?o:{});return n.refresh&&g.remove(p.books),e.get(p.books,n).then(function(e){return e=e.data||{},e.error?r.reject(e.message):void r.resolve(e.data)},function(e){return e.data&&e.data.error?r.reject(error.message):void r.reject(e)}).catch(function(e){r.reject(e)}),r.promise}function c(o,r){var n=t.defer(),i=a.merge({},a.isObject(r)?r:{});return e.post(p.books,o,i).then(function(e){return e=e.data||{},e.error?(n.reject(e.data.join(" ")||e.message),n.promise):void n.resolve(e.message)},function(e){return e.data&&e.data.error?(n.reject(e.data.message),n.promise):void n.reject(e)}).catch(function(e){n.reject(e)}),n.promise}function l(o,r){var n=t.defer(),i=a.merge({cache:!0},a.isObject(r)?r:{});if(!o)return n.reject("Invalid Id"),n.promise;var s=p.book.replace("{book_id}",o);return e.delete(s,i).then(function(e){return e=e.data||{},e.error?(n.reject(e.message),n.promise):void n.resolve(e.message)},function(e){return e.data&&e.data.error?(n.reject(error.message),n.promise):void n.reject(e)}).catch(function(e){n.reject(e)}),n.promise}function u(o,r,n){var i=t.defer(),s=a.merge({cache:!0},a.isObject(n)?n:{});if(!o)return i.reject("Invalid Id"),i.promise;var c=p.book.replace("{book_id}",o);return e.put(c,r,s).then(function(e){return e=e.data||{},e.error?(i.reject(e.message),i.promise):void i.resolve(e.message)},function(e){return e.data&&e.data.error?(i.reject(error.message),i.promise):void i.reject(e)}).catch(function(e){i.reject(e)}),i.promise}function d(){g.removeAll()}var p={books:r.ensureUrl([o.api_url,o.paths.books]),book:r.ensureUrl([o.api_url,o.paths.book])},g=n.get("$http");return{getBooks:s,getBook:i,deleteBook:l,createBook:c,updateBook:u,flushAll:d}};angular.module("app.services.BookService",[]).factory("BookService",["$http","$q","AppConfig","UtilService","_","$cacheFactory",_BookService]);var _CategoryService=function(e,t,o,r,a){var n={categories:r.ensureUrl([o.api_url,o.paths.categories]),category:r.ensureUrl([o.api_url,o.paths.category]),categoryAndBooks:r.ensureUrl([o.api_url,o.paths.book_and_category])};return{getCategories:function(o){var r=t.defer(),i=a.merge({cache:!0},a.isObject(o)?o:{});return e.get(n.categories,i).then(function(e){return e=e.data||{},e.error?r.reject(e.message):void r.resolve(e.data)},function(e){return e.data&&e.data.error?r.reject(error.message):void r.reject(e)}),r.promise},getCategoriesWithBooks:function(o){var r=t.defer(),i=a.merge({cache:!0},a.isObject(o)?o:{});return e.get(n.categoryAndBooks,i).then(function(e){return e=e.data||{},e.error?r.reject(e.message):void r.resolve(e.data)},function(e){return e.data&&e.data.error?r.reject(error.message):void r.reject(e)}),r.promise}}};angular.module("app.services.CategoryService",[]).factory("CategoryService",["$http","$q","AppConfig","UtilService","_",_CategoryService]);var _ConfigurationService=function(e,t,o,r){return{getConfig:function(){return e.get(r.ensureUrl(o.base_url),{cache:!0}).then(function(e){return e.data.data&&e.data.data.length?e.data.data[0]:e.data},function(e){return e.data})}}};angular.module("app.services.ConfigurationService",[]).factory("ConfigurationService",["$http","$q","AppConfig","UtilService",_ConfigurationService]);var _spinnerContainer=function(e,t,o){function r(e,o,r){t.spin=!1}return{restrict:"E",transclude:!0,templateUrl:function(){return"app-templates/spinner-container"},replace:!0,link:r}},_spinner=function(){return{restrict:"E",replace:!0,templateUrl:function(){return"app-templates/spinner"}}},_SpinnerService=function(e,t,o){return{show:function(){o.debug("Showing spinner"),t.spin=!0},hide:function(){o.debug("Hidding spinner"),t.spin=!1},isVisible:function(){return!!t.spin}}};angular.module("app.services.SpinnerService",[]).run(["$templateCache",function(e){var t='            <div class="spinner-container" ng-if="spin">                <ng-transclude></ng-transclude>            </div>',o='            <div class="spinner">                <div class="double-bounce1"></div>                <div class="double-bounce2"></div>            </div>';e.put("app-templates/spinner-container",t),e.put("app-templates/spinner",o)}]).directive("spinnerContainer",["$log","$rootScope","$timeout",_spinnerContainer]).directive("spinner",[_spinner]).factory("SpinnerService",["_","$rootScope","$log",_SpinnerService]);var _UtilService=function(e,t){function o(e,t){t=!!t,e=e?[].concat(e):[];var o=e.join("/");if(!/^https?\s*:\s*\/\//.test(o)){var r=t?"https://":"http://";o=r+o}return o}function r(e,t){t=t||6;for(var o=_.chunk(e,t),r=o.length,a=[],n=0;n<r;n++)a.push({items:o[n]});return a}return{ensureUrl:o,createRows:r}};angular.module("app.services.UtilService",[]).factory("UtilService",["$http","$q",_UtilService]);